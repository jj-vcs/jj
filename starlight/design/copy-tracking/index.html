<!DOCTYPE html><html lang="en" dir="ltr" data-theme="dark" data-has-toc data-has-sidebar class="astro-bguv2lll"> <head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Copy Tracking and Tracing Design | Jujutsu docs</title><link rel="canonical" href="https://docs.jj-vcs.dev/starlight/design/copy-tracking/"/><link rel="sitemap" href="/starlight/sitemap-index.xml"/><link rel="shortcut icon" href="/starlight/images/jj-logo.svg" type="image/svg+xml"/><meta name="generator" content="Astro v5.16.3"/><meta name="generator" content="Starlight v0.37.0"/><meta property="og:title" content="Copy Tracking and Tracing Design"/><meta property="og:type" content="article"/><meta property="og:url" content="https://docs.jj-vcs.dev/starlight/design/copy-tracking/"/><meta property="og:locale" content="en"/><meta property="og:site_name" content="Jujutsu docs"/><meta name="twitter:card" content="summary_large_image"/><script>
	window.StarlightThemeProvider = (() => {
		const storedTheme =
			typeof localStorage !== 'undefined' && localStorage.getItem('starlight-theme');
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
		document.documentElement.dataset.theme = theme === 'light' ? 'light' : 'dark';
		return {
			updatePickers(theme = storedTheme || 'auto') {
				document.querySelectorAll('starlight-theme-select').forEach((picker) => {
					const select = picker.querySelector('select');
					if (select) select.value = theme;
					/** @type {HTMLTemplateElement | null} */
					const tmpl = document.querySelector(`#theme-icons`);
					const newIcon = tmpl && tmpl.content.querySelector('.' + theme);
					if (newIcon) {
						const oldIcon = picker.querySelector('svg.label-icon');
						if (oldIcon) {
							oldIcon.replaceChildren(...newIcon.cloneNode(true).childNodes);
						}
					}
				});
			},
		};
	})();
</script><template id="theme-icons"><svg aria-hidden="true" class="light astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M5 12a1 1 0 0 0-1-1H3a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1Zm.64 5-.71.71a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l.71-.71A1 1 0 0 0 5.64 17ZM12 5a1 1 0 0 0 1-1V3a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm5.66 2.34a1 1 0 0 0 .7-.29l.71-.71a1 1 0 1 0-1.41-1.41l-.66.71a1 1 0 0 0 0 1.41 1 1 0 0 0 .66.29Zm-12-.29a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.71-.71a1.004 1.004 0 1 0-1.43 1.41l.73.71ZM21 11h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2Zm-2.64 6A1 1 0 0 0 17 18.36l.71.71a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.76-.66ZM12 6.5a5.5 5.5 0 1 0 5.5 5.5A5.51 5.51 0 0 0 12 6.5Zm0 9a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0 3.5a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg><svg aria-hidden="true" class="dark astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.64 13a1 1 0 0 0-1.05-.14 8.049 8.049 0 0 1-3.37.73 8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.69 1 1 0 0 0-.36-1.05Zm-9.5 6.69A8.14 8.14 0 0 1 7.08 5.22v.27a10.15 10.15 0 0 0 10.14 10.14 9.784 9.784 0 0 0 2.1-.22 8.11 8.11 0 0 1-7.18 4.32v-.04Z"/></svg><svg aria-hidden="true" class="auto astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg></template><link rel="stylesheet" href="/starlight/_astro/print.DNXP8c50.css" media="print"><link rel="stylesheet" href="/starlight/_astro/index.DHaNDMTl.css">
<style>@layer starlight.components{:root{--sl-badge-default-border: var(--sl-color-accent);--sl-badge-default-bg: var(--sl-color-accent-low);--sl-badge-default-text: #fff;--sl-badge-note-border: var(--sl-color-blue);--sl-badge-note-bg: var(--sl-color-blue-low);--sl-badge-note-text: #fff;--sl-badge-danger-border: var(--sl-color-red);--sl-badge-danger-bg: var(--sl-color-red-low);--sl-badge-danger-text: #fff;--sl-badge-success-border: var(--sl-color-green);--sl-badge-success-bg: var(--sl-color-green-low);--sl-badge-success-text: #fff;--sl-badge-caution-border: var(--sl-color-orange);--sl-badge-caution-bg: var(--sl-color-orange-low);--sl-badge-caution-text: #fff;--sl-badge-tip-border: var(--sl-color-purple);--sl-badge-tip-bg: var(--sl-color-purple-low);--sl-badge-tip-text: #fff}[data-theme=light]:root{--sl-badge-default-bg: var(--sl-color-accent-high);--sl-badge-note-bg: var(--sl-color-blue-high);--sl-badge-danger-bg: var(--sl-color-red-high);--sl-badge-success-bg: var(--sl-color-green-high);--sl-badge-caution-bg: var(--sl-color-orange-high);--sl-badge-tip-bg: var(--sl-color-purple-high)}.sl-badge:where(.astro-avdet4wd){display:inline-block;border:1px solid var(--sl-color-border-badge);border-radius:.25rem;font-family:var(--sl-font-system-mono);line-height:normal;color:var(--sl-color-text-badge);background-color:var(--sl-color-bg-badge);overflow-wrap:anywhere}.sidebar-content .sl-badge:where(.astro-avdet4wd){line-height:1;font-size:var(--sl-text-xs);padding:.125rem .375rem}.sidebar-content a[aria-current=page]>.sl-badge:where(.astro-avdet4wd){--sl-color-bg-badge: transparent;--sl-color-border-badge: currentColor;color:inherit}.default:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-default-bg);--sl-color-border-badge: var(--sl-badge-default-border);--sl-color-text-badge: var(--sl-badge-default-text)}.note:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-note-bg);--sl-color-border-badge: var(--sl-badge-note-border);--sl-color-text-badge: var(--sl-badge-note-text)}.danger:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-danger-bg);--sl-color-border-badge: var(--sl-badge-danger-border);--sl-color-text-badge: var(--sl-badge-danger-text)}.success:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-success-bg);--sl-color-border-badge: var(--sl-badge-success-border);--sl-color-text-badge: var(--sl-badge-success-text)}.tip:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-tip-bg);--sl-color-border-badge: var(--sl-badge-tip-border);--sl-color-text-badge: var(--sl-badge-tip-text)}.caution:where(.astro-avdet4wd){--sl-color-bg-badge: var(--sl-badge-caution-bg);--sl-color-border-badge: var(--sl-badge-caution-border);--sl-color-text-badge: var(--sl-badge-caution-text)}.small:where(.astro-avdet4wd){font-size:var(--sl-text-xs);padding:.125rem .25rem}.medium:where(.astro-avdet4wd){font-size:var(--sl-text-sm);padding:.175rem .35rem}.large:where(.astro-avdet4wd){font-size:var(--sl-text-base);padding:.225rem .45rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) .sl-badge:where(.astro-avdet4wd){vertical-align:middle}}
@layer starlight.components{svg:where(.astro-c6vsoqas){color:var(--sl-icon-color);font-size:var(--sl-icon-size, 1em);width:1em;height:1em}}
@layer starlight.components{starlight-tabs:where(.astro-esqgolmp){display:block}.tablist-wrapper:where(.astro-esqgolmp){overflow-x:auto}:where(.astro-esqgolmp)[role=tablist]{display:flex;list-style:none;border-bottom:2px solid var(--sl-color-gray-5);padding:0}.tab:where(.astro-esqgolmp){display:flex}.tab:where(.astro-esqgolmp)>:where(.astro-esqgolmp)[role=tab]{--sl-tab-color-border: var(--sl-color-gray-5);display:flex;align-items:center;gap:.5rem;line-height:var(--sl-line-height-headings);padding:.275rem 1.25rem;text-decoration:none;box-shadow:0 2px 0 var(--sl-tab-color-border);color:var(--sl-color-gray-3);outline-offset:var(--sl-outline-offset-inside);overflow-wrap:initial}.tab:where(.astro-esqgolmp) :where(.astro-esqgolmp)[role=tab][aria-selected=true]{--sl-tab-color-border: var(--sl-color-text-accent);color:var(--sl-color-white);font-weight:600}.tablist-wrapper:where(.astro-esqgolmp)~[role=tabpanel]{margin-top:1rem}}
@layer starlight.components{.sl-steps{--bullet-size: calc(var(--sl-line-height) * 1rem);--bullet-margin: .375rem;list-style:none;counter-reset:steps-counter var(--sl-steps-start, 0);padding-inline-start:0}.sl-steps>li{counter-increment:steps-counter;position:relative;padding-inline-start:calc(var(--bullet-size) + 1rem);padding-bottom:1px;min-height:calc(var(--bullet-size) + var(--bullet-margin))}.sl-steps>li+li{margin-top:0}.sl-steps>li:before{content:counter(steps-counter);position:absolute;top:0;inset-inline-start:0;width:var(--bullet-size);height:var(--bullet-size);line-height:var(--bullet-size);font-size:var(--sl-text-xs);font-weight:600;text-align:center;color:var(--sl-color-white);background-color:var(--sl-color-gray-6);border-radius:99rem;box-shadow:inset 0 0 0 1px var(--sl-color-gray-5)}.sl-steps>li:after{--guide-width: 1px;content:"";position:absolute;top:calc(var(--bullet-size) + var(--bullet-margin));bottom:var(--bullet-margin);inset-inline-start:calc((var(--bullet-size) - var(--guide-width)) / 2);width:var(--guide-width);background-color:var(--sl-color-hairline-light)}}@layer starlight.content{.sl-steps>li>:first-child{--lh: calc(1em * var(--sl-line-height));--shift-y: calc(.5 * (var(--bullet-size) - var(--lh)));transform:translateY(var(--shift-y));margin-bottom:var(--shift-y)}.sl-steps>li>:first-child:where(h1,h2,h3,h4,h5,h6){--lh: calc(1em * var(--sl-line-height-headings))}@supports (--prop: 1lh){.sl-steps>li>:first-child{--lh: 1lh}}}
@layer starlight.components{.sl-link-button:where(.astro-xwgiixxa){align-items:center;border:1px solid transparent;border-radius:999rem;display:inline-flex;font-size:var(--sl-text-sm);gap:.5em;line-height:1.1875;outline-offset:.25rem;padding:.4375rem 1.125rem;text-decoration:none}.sl-link-button:where(.astro-xwgiixxa).primary{background:var(--sl-color-text-accent);border-color:var(--sl-color-text-accent);color:var(--sl-color-black)}.sl-link-button:where(.astro-xwgiixxa).primary:hover{color:var(--sl-color-black)}.sl-link-button:where(.astro-xwgiixxa).secondary{border-color:inherit;color:var(--sl-color-white)}.sl-link-button:where(.astro-xwgiixxa).minimal{color:var(--sl-color-white);padding-inline:0}.sl-link-button:where(.astro-xwgiixxa) svg{flex-shrink:0}@media(min-width:50rem){.sl-link-button:where(.astro-xwgiixxa){font-size:var(--sl-text-base);padding:.9375rem 1.25rem}}.sl-markdown-content .sl-link-button:where(.astro-xwgiixxa){margin-inline-end:1rem}.sl-markdown-content .sl-link-button:where(.astro-xwgiixxa):not(:where(p *)){margin-block:1rem}}
</style><script type="module" src="/starlight/_astro/page.B1D-nYk3.js"></script></head> <body class="astro-bguv2lll"> <a href="#_top" class="astro-7q3lir66">Skip to content</a>  <div class="page sl-flex astro-vrdttmbt"> <header class="header astro-vrdttmbt"><div class="header astro-kmkmnagf"> <div class="title-wrapper sl-flex astro-kmkmnagf"> <a href="/starlight/" class="site-title sl-flex astro-m46x6ez3">  <img class="astro-m46x6ez3" alt src="/starlight/_astro/jj-logo.CIiglsa3.svg" width="1024" height="1024">  <span class="astro-m46x6ez3" translate="no"> Jujutsu docs </span> </a>  </div> <div class="sl-flex print:hidden astro-kmkmnagf"> <site-search class="astro-kmkmnagf astro-v37mnknz" data-translations="{&#34;placeholder&#34;:&#34;Search&#34;}"> <button data-open-modal disabled aria-label="Search" aria-keyshortcuts="Control+K" class="astro-v37mnknz"> <svg aria-hidden="true" class="astro-v37mnknz astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z"/></svg> <span class="sl-hidden md:sl-block astro-v37mnknz" aria-hidden="true">Search</span> <kbd class="sl-hidden md:sl-flex astro-v37mnknz" style="display: none;"> <kbd class="astro-v37mnknz">Ctrl</kbd><kbd class="astro-v37mnknz">K</kbd> </kbd> </button> <dialog style="padding:0" aria-label="Search" class="astro-v37mnknz"> <div class="dialog-frame sl-flex astro-v37mnknz">  <button data-close-modal class="sl-flex md:sl-hidden astro-v37mnknz"> Cancel </button> <div class="search-container astro-v37mnknz"> <div id="starlight__search" class="astro-v37mnknz"></div> </div> </div> </dialog> </site-search>  <script>
	(() => {
		const openBtn = document.querySelector('button[data-open-modal]');
		const shortcut = openBtn?.querySelector('kbd');
		if (!openBtn || !(shortcut instanceof HTMLElement)) return;
		const platformKey = shortcut.querySelector('kbd');
		if (platformKey && /(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)) {
			platformKey.textContent = 'âŒ˜';
			openBtn.setAttribute('aria-keyshortcuts', 'Meta+K');
		}
		shortcut.style.display = '';
	})();
</script> <script type="module" src="/starlight/_astro/Search.astro_astro_type_script_index_0_lang.CIUB7SL0.js"></script>   </div> <div class="sl-hidden md:sl-flex print:hidden right-group astro-kmkmnagf"> <div class="sl-flex social-icons astro-kmkmnagf"> <a href="https://github.com/jj-vcs/jj" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">GitHub</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg></a><a href="https://discord.gg/dkmfj3aGQN" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">Discord</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M20.32 4.37a19.8 19.8 0 0 0-4.93-1.51 13.78 13.78 0 0 0-.64 1.28 18.27 18.27 0 0 0-5.5 0 12.64 12.64 0 0 0-.64-1.28h-.05A19.74 19.74 0 0 0 3.64 4.4 20.26 20.26 0 0 0 .11 18.09l.02.02a19.9 19.9 0 0 0 6.04 3.03l.04-.02a14.24 14.24 0 0 0 1.23-2.03.08.08 0 0 0-.05-.07 13.1 13.1 0 0 1-1.9-.92.08.08 0 0 1 .02-.1 10.2 10.2 0 0 0 .41-.31h.04a14.2 14.2 0 0 0 12.1 0l.04.01a9.63 9.63 0 0 0 .4.32.08.08 0 0 1-.03.1 12.29 12.29 0 0 1-1.9.91.08.08 0 0 0-.02.1 15.97 15.97 0 0 0 1.27 2.01h.04a19.84 19.84 0 0 0 6.03-3.05v-.03a20.12 20.12 0 0 0-3.57-13.69ZM8.02 15.33c-1.18 0-2.16-1.08-2.16-2.42 0-1.33.96-2.42 2.16-2.42 1.21 0 2.18 1.1 2.16 2.42 0 1.34-.96 2.42-2.16 2.42Zm7.97 0c-1.18 0-2.15-1.08-2.15-2.42 0-1.33.95-2.42 2.15-2.42 1.22 0 2.18 1.1 2.16 2.42 0 1.34-.94 2.42-2.16 2.42Z"/></svg></a> </div> <div class="version-switcher astro-eanuhfmr" id="version-switcher-container" style="display: none;"> <label for="version-select" class="sl-hidden astro-eanuhfmr">Select documentation version</label> <select id="version-select" class="version-select astro-eanuhfmr"> <option class="astro-eanuhfmr">Loading versions...</option> </select> </div> <script>(function(){const siteBase = "/";

    // Fetch versions client-side and populate the dropdown
    async function loadVersions() {
      const container = document.getElementById('version-switcher-container');
      const select = document.getElementById('version-select');

      if (!container || !select) return;

      try {
        const response = await fetch(`${siteBase}versions.json`);
        if (!response.ok) {
          // No versions.json available (e.g., in development)
          return;
        }

        const versions = await response.json();
        if (!versions || versions.length === 0) return;

        // Determine current version from URL path
        const pathMatch = window.location.pathname.match(/^\/([^\/]+)/);
        let currentVersion = 'unknown';

        if (pathMatch) {
          const pathVersion = pathMatch[1];
          // Check if this is a direct version match
          let versionObj = versions.find(v => v.version === pathVersion);
          // Check if this matches an alias
          if (!versionObj) {
            versionObj = versions.find(v => v.aliases && v.aliases.includes(pathVersion));
          }
          currentVersion = versionObj?.version || pathVersion;
        }

        // Clear and populate the select
        select.innerHTML = '';
        versions.forEach(v => {
          const option = document.createElement('option');
          option.value = v.version;

          // Display title with alias if it has one
          const displayTitle = v.aliases && v.aliases.length > 0
            ? `${v.title} (${v.aliases.join(', ')})`
            : v.title;
          option.textContent = displayTitle;

          if (v.version === currentVersion) {
            option.selected = true;
          }

          select.appendChild(option);
        });

        // Show the container
        container.style.display = 'flex';

        // Add change handler
        select.addEventListener('change', (e) => {
          const selectedVersion = e.target.value;
          const currentPath = window.location.pathname;
          const versionRegex = /^\/[^\/]+/;
          const pagePath = currentPath.replace(versionRegex, '').replace(/^\//, '');
          window.location.href = `${siteBase}${selectedVersion}/${pagePath}`;
        });
      } catch (error) {
        console.debug('Could not load versions.json:', error);
      }
    }

    // Load versions when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadVersions);
    } else {
      loadVersions();
    }
  })();</script>  <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-4yphtoen"> <span class="sr-only astro-4yphtoen">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select autocomplete="off" class="astro-4yphtoen"> <option value="dark" class="astro-4yphtoen">Dark</option><option value="light" class="astro-4yphtoen">Light</option><option value="auto" selected class="astro-4yphtoen">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg> </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script> <script type="module">const r="starlight-theme",o=e=>e==="auto"||e==="dark"||e==="light"?e:"auto",c=()=>o(typeof localStorage<"u"&&localStorage.getItem(r));function n(e){typeof localStorage<"u"&&localStorage.setItem(r,e==="light"||e==="dark"?e:"")}const l=()=>matchMedia("(prefers-color-scheme: light)").matches?"light":"dark";function t(e){StarlightThemeProvider.updatePickers(e),document.documentElement.dataset.theme=e==="auto"?l():e,n(e)}matchMedia("(prefers-color-scheme: light)").addEventListener("change",()=>{c()==="auto"&&t("auto")});class s extends HTMLElement{constructor(){super(),t(c()),this.querySelector("select")?.addEventListener("change",a=>{a.currentTarget instanceof HTMLSelectElement&&t(o(a.currentTarget.value))})}}customElements.define("starlight-theme-select",s);</script> <script type="module">class s extends HTMLElement{constructor(){super();const e=this.querySelector("select");e&&(e.addEventListener("change",t=>{t.currentTarget instanceof HTMLSelectElement&&(window.location.pathname=t.currentTarget.value)}),window.addEventListener("pageshow",t=>{if(!t.persisted)return;const n=e.querySelector("option[selected]")?.index;n!==e.selectedIndex&&(e.selectedIndex=n??0)}))}}customElements.define("starlight-lang-select",s);</script> </div> </div> </header> <nav class="sidebar print:hidden astro-vrdttmbt" aria-label="Main"> <starlight-menu-button class="print:hidden astro-jif73yzw"> <button aria-expanded="false" aria-label="Menu" aria-controls="starlight__sidebar" class="sl-flex md:sl-hidden astro-jif73yzw"> <svg aria-hidden="true" class="open-menu astro-jif73yzw astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"/></svg> <svg aria-hidden="true" class="close-menu astro-jif73yzw astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="m13.41 12 6.3-6.29a1.004 1.004 0 1 0-1.42-1.42L12 10.59l-6.29-6.3a1.004 1.004 0 0 0-1.42 1.42l6.3 6.29-6.3 6.29a1 1 0 0 0 0 1.42.998.998 0 0 0 1.42 0l6.29-6.3 6.29 6.3a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.42L13.41 12Z"/></svg> </button> </starlight-menu-button> <script type="module">class s extends HTMLElement{constructor(){super(),this.btn=this.querySelector("button"),this.btn.addEventListener("click",()=>this.toggleExpanded());const t=this.closest("nav");t&&t.addEventListener("keyup",e=>this.closeOnEscape(e))}setExpanded(t){this.setAttribute("aria-expanded",String(t)),document.body.toggleAttribute("data-mobile-menu-expanded",t)}toggleExpanded(){this.setExpanded(this.getAttribute("aria-expanded")!=="true")}closeOnEscape(t){t.code==="Escape"&&(this.setExpanded(!1),this.btn.focus())}}customElements.define("starlight-menu-button",s);</script>   <div id="starlight__sidebar" class="sidebar-pane astro-vrdttmbt"> <div class="sidebar-content sl-flex astro-vrdttmbt"> <sl-sidebar-state-persist data-hash="0tme7ck" class="astro-kku4brbg"> <script aria-hidden="true">
		(() => {
			try {
				if (!matchMedia('(min-width: 50em)').matches) return;
				/** @type {HTMLElement | null} */
				const target = document.querySelector('sl-sidebar-state-persist');
				const state = JSON.parse(sessionStorage.getItem('sl-sidebar-state') || '0');
				if (!target || !state || target.dataset.hash !== state.hash) return;
				window._starlightScrollRestore = state.scroll;
				customElements.define(
					'sl-sidebar-restore',
					class SidebarRestore extends HTMLElement {
						connectedCallback() {
							try {
								const idx = parseInt(this.dataset.index || '');
								const details = this.closest('details');
								if (details && typeof state.open[idx] === 'boolean') details.open = state.open[idx];
							} catch {}
						}
					}
				);
			} catch {}
		})();
	</script>  <ul class="top-level astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">Home</span>  </a> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Getting started</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="0"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/install-and-setup/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Installation and setup</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/tutorial/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Tutorial and bird&#39;s eye view</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/gerrit/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Working with Gerrit</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/github/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Working with GitHub</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/windows/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Working on Windows</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <a href="/starlight/faq/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">FAQ</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/cli-reference/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">CLI reference</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/testimonials/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">Testimonials</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/community_tools/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">Community-built tools</span>  </a> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Concepts</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="1"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/working-copy/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Working copy</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/bookmarks/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Bookmarks</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/conflicts/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Conflicts</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/operation-log/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Operation log</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/glossary/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Glossary</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Guides</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="2"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/guides/divergence/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Divergent changes</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/guides/multiple-remotes/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Multiple remotes</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Reference</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="3"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/config/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Settings</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/filesets/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Fileset language</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/revsets/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Revset language</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/templates/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Templating language</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Comparisons</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="4"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/git-comparison/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Git comparison</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/git-command-table/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Git command table</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/git-compatibility/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Git compatibility</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/git-experts/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Jujutsu for Git experts</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/sapling-comparison/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Sapling comparison</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/related-work/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Other related work</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Technical details</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="5"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/core_tenets/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Core tenets</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/technical/architecture/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Architecture</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/technical/concurrency/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Concurrency</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/technical/conflicts/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Conflicts</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Contributing</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="6"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/contributing/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Guidelines and &quot;How to...?&quot;</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/code-of-conduct/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Code of conduct</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/style_guide/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Style guide</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design_docs/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Design docs</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design_doc_blueprint/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Design doc blueprint</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/releasing/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Releasing</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/governance/temporary-voting/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Temporary voting for governance</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/governance/governance/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Governance</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Design docs</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="7"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/starlight/design/git-submodules/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">git-submodules</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design/git-submodule-storage/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">git-submodule-storage</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design/run/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">JJ run</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design/sparse-v2/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Sparse patterns v2</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design/tracking-branches/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Tracking branches</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design/copy-tracking/" aria-current="page" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Copy tracking and tracing</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/design/secure-config/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Secure config</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <a href="/starlight/roadmap/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">Development roadmap</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/starlight/changelog/" aria-current="false" class="large astro-3ii7xxms"> <span class="astro-3ii7xxms">Changelog</span>  </a> </li> </ul>   <script aria-hidden="true">
		(() => {
			const scroller = document.getElementById('starlight__sidebar');
			if (!window._starlightScrollRestore || !scroller) return;
			scroller.scrollTop = window._starlightScrollRestore;
			delete window._starlightScrollRestore;
		})();
	</script> </sl-sidebar-state-persist>  <div class="md:sl-hidden"> <div class="mobile-preferences sl-flex astro-wu23bvmt"> <div class="social-icons astro-wu23bvmt"> <a href="https://github.com/jj-vcs/jj" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">GitHub</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg></a><a href="https://discord.gg/dkmfj3aGQN" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">Discord</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M20.32 4.37a19.8 19.8 0 0 0-4.93-1.51 13.78 13.78 0 0 0-.64 1.28 18.27 18.27 0 0 0-5.5 0 12.64 12.64 0 0 0-.64-1.28h-.05A19.74 19.74 0 0 0 3.64 4.4 20.26 20.26 0 0 0 .11 18.09l.02.02a19.9 19.9 0 0 0 6.04 3.03l.04-.02a14.24 14.24 0 0 0 1.23-2.03.08.08 0 0 0-.05-.07 13.1 13.1 0 0 1-1.9-.92.08.08 0 0 1 .02-.1 10.2 10.2 0 0 0 .41-.31h.04a14.2 14.2 0 0 0 12.1 0l.04.01a9.63 9.63 0 0 0 .4.32.08.08 0 0 1-.03.1 12.29 12.29 0 0 1-1.9.91.08.08 0 0 0-.02.1 15.97 15.97 0 0 0 1.27 2.01h.04a19.84 19.84 0 0 0 6.03-3.05v-.03a20.12 20.12 0 0 0-3.57-13.69ZM8.02 15.33c-1.18 0-2.16-1.08-2.16-2.42 0-1.33.96-2.42 2.16-2.42 1.21 0 2.18 1.1 2.16 2.42 0 1.34-.96 2.42-2.16 2.42Zm7.97 0c-1.18 0-2.15-1.08-2.15-2.42 0-1.33.95-2.42 2.15-2.42 1.22 0 2.18 1.1 2.16 2.42 0 1.34-.94 2.42-2.16 2.42Z"/></svg></a> </div> <div class="version-switcher astro-eanuhfmr" id="version-switcher-container" style="display: none;"> <label for="version-select" class="sl-hidden astro-eanuhfmr">Select documentation version</label> <select id="version-select" class="version-select astro-eanuhfmr"> <option class="astro-eanuhfmr">Loading versions...</option> </select> </div> <script>(function(){const siteBase = "/";

    // Fetch versions client-side and populate the dropdown
    async function loadVersions() {
      const container = document.getElementById('version-switcher-container');
      const select = document.getElementById('version-select');

      if (!container || !select) return;

      try {
        const response = await fetch(`${siteBase}versions.json`);
        if (!response.ok) {
          // No versions.json available (e.g., in development)
          return;
        }

        const versions = await response.json();
        if (!versions || versions.length === 0) return;

        // Determine current version from URL path
        const pathMatch = window.location.pathname.match(/^\/([^\/]+)/);
        let currentVersion = 'unknown';

        if (pathMatch) {
          const pathVersion = pathMatch[1];
          // Check if this is a direct version match
          let versionObj = versions.find(v => v.version === pathVersion);
          // Check if this matches an alias
          if (!versionObj) {
            versionObj = versions.find(v => v.aliases && v.aliases.includes(pathVersion));
          }
          currentVersion = versionObj?.version || pathVersion;
        }

        // Clear and populate the select
        select.innerHTML = '';
        versions.forEach(v => {
          const option = document.createElement('option');
          option.value = v.version;

          // Display title with alias if it has one
          const displayTitle = v.aliases && v.aliases.length > 0
            ? `${v.title} (${v.aliases.join(', ')})`
            : v.title;
          option.textContent = displayTitle;

          if (v.version === currentVersion) {
            option.selected = true;
          }

          select.appendChild(option);
        });

        // Show the container
        container.style.display = 'flex';

        // Add change handler
        select.addEventListener('change', (e) => {
          const selectedVersion = e.target.value;
          const currentPath = window.location.pathname;
          const versionRegex = /^\/[^\/]+/;
          const pagePath = currentPath.replace(versionRegex, '').replace(/^\//, '');
          window.location.href = `${siteBase}${selectedVersion}/${pagePath}`;
        });
      } catch (error) {
        console.debug('Could not load versions.json:', error);
      }
    }

    // Load versions when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadVersions);
    } else {
      loadVersions();
    }
  })();</script>  <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-4yphtoen"> <span class="sr-only astro-4yphtoen">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select autocomplete="off" class="astro-4yphtoen"> <option value="dark" class="astro-4yphtoen">Dark</option><option value="light" class="astro-4yphtoen">Light</option><option value="auto" selected class="astro-4yphtoen">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg> </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script>   </div>  </div> </div> </div> </nav> <div class="main-frame astro-vrdttmbt">  <script type="module">const a=document.getElementById("starlight__sidebar"),n=a?.querySelector("sl-sidebar-state-persist"),o="sl-sidebar-state",i=()=>{let t=[];const e=n?.dataset.hash||"";try{const s=sessionStorage.getItem(o),r=JSON.parse(s||"{}");Array.isArray(r.open)&&r.hash===e&&(t=r.open)}catch{}return{hash:e,open:t,scroll:a?.scrollTop||0}},c=t=>{try{sessionStorage.setItem(o,JSON.stringify(t))}catch{}},d=()=>c(i()),l=(t,e)=>{const s=i();s.open[e]=t,c(s)};n?.addEventListener("click",t=>{if(!(t.target instanceof Element))return;const e=t.target.closest("summary")?.closest("details");if(!e)return;const s=e.querySelector("sl-sidebar-restore"),r=parseInt(s?.dataset.index||"");isNaN(r)||l(!e.open,r)});addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&d()});addEventListener("pageHide",d);</script> <div class="lg:sl-flex astro-67yu43on"> <aside class="right-sidebar-container print:hidden astro-67yu43on"> <div class="right-sidebar astro-67yu43on"> <div class="lg:sl-hidden astro-pb3aqygn"><mobile-starlight-toc data-min-h="2" data-max-h="3" class="astro-doynk5tl"><nav aria-labelledby="starlight__on-this-page--mobile" class="astro-doynk5tl"><details id="starlight__mobile-toc" class="astro-doynk5tl"><summary id="starlight__on-this-page--mobile" class="sl-flex astro-doynk5tl"><span class="toggle sl-flex astro-doynk5tl">On this page<svg aria-hidden="true" class="caret astro-doynk5tl astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></span><span class="display-current astro-doynk5tl"></span></summary><div class="dropdown astro-doynk5tl"><ul class="isMobile astro-g2bywc46" style="--depth: 0;"> <li class="astro-g2bywc46" style="--depth: 0;"> <a href="#_top" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#objective" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Objective</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#desired-ux" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Desired UX</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#high-level-design" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">High-level Design</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#diffing" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Diffing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#merging" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Merging</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#log" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Log</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#annotate" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Annotate</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#representation-in-git" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Representation in Git</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#representation-in-cloud-repo-eg-google" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Representation in cloud repo (e.g. Google)</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#implementation-plan" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Implementation plan</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#alternatives-considered" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Alternatives considered</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#detect-copies-like-git" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Detect copies (like Git)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#record-logical-file-identifiers-in-trees-bitkeeper-like-model" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Record logical file identifiers in trees (BitKeeper-like model)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#include-copy-info-in-the-fileid-mercurial-like-model" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Include copy info in the FileId (Mercurial-like model)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#hybrid-snapshotpatch-model-with-copy-info-stored-in-commits" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Hybrid snapshot/patch model with copy info stored in commits</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#footnote-label" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Footnotes</span> </a>  </li> </ul> </div></details></nav></mobile-starlight-toc><script type="module" src="/starlight/_astro/MobileTableOfContents.astro_astro_type_script_index_0_lang.C181hMzK.js"></script></div><div class="right-sidebar-panel sl-hidden lg:sl-block astro-pb3aqygn"><div class="sl-container astro-pb3aqygn"><starlight-toc data-min-h="2" data-max-h="3"><nav aria-labelledby="starlight__on-this-page"><h2 id="starlight__on-this-page">On this page</h2><ul class="astro-g2bywc46" style="--depth: 0;"> <li class="astro-g2bywc46" style="--depth: 0;"> <a href="#_top" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#objective" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Objective</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#desired-ux" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Desired UX</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#high-level-design" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">High-level Design</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#diffing" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Diffing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#merging" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Merging</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#log" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Log</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#annotate" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Annotate</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#representation-in-git" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Representation in Git</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#representation-in-cloud-repo-eg-google" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Representation in cloud repo (e.g. Google)</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#implementation-plan" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Implementation plan</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#alternatives-considered" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Alternatives considered</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#detect-copies-like-git" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Detect copies (like Git)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#record-logical-file-identifiers-in-trees-bitkeeper-like-model" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Record logical file identifiers in trees (BitKeeper-like model)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#include-copy-info-in-the-fileid-mercurial-like-model" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Include copy info in the FileId (Mercurial-like model)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#hybrid-snapshotpatch-model-with-copy-info-stored-in-commits" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">Hybrid snapshot/patch model with copy info stored in commits</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#footnote-label" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Footnotes</span> </a>  </li> </ul> </nav></starlight-toc><script type="module" src="/starlight/_astro/TableOfContents.astro_astro_type_script_index_0_lang.CKWWgpjV.js"></script></div></div> </div> </aside> <div class="main-pane astro-67yu43on">  <main data-pagefind-body class="astro-bguv2lll" lang="en" dir="ltr">    <div class="content-panel astro-7nkwcw3z"> <div class="sl-container astro-7nkwcw3z"> <h1 id="_top" class="astro-j6tvhyss">Copy Tracking and Tracing Design</h1>  </div> </div>  <div class="content-panel astro-7nkwcw3z"> <div class="sl-container astro-7nkwcw3z"> <div class="sl-markdown-content"> <p>Authors: <a href="mailto:dploch@google.com">Daniel Ploch</a>, <a href="mailto:martinvonz@google.com">Martin von Zweigbergk</a></p>
<p><strong>Summary:</strong> This Document documents an approach to tracking and detecting copy
information in jj repos, in a way that is compatible with both Gitâ€™s detection
model and with custom backends that have more complicated tracking of copy
information. This design affects the output of diff commands as well as the
results of rebasing across remote copies.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="objective">Objective</h2><a class="sl-anchor-link" href="#objective"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œObjectiveâ€</span></a></div>
<p>Add support for copy information that is sufficient for at least the following
use cases:</p>
<ul>
<li>Diffing: If a file has been copied, show a diff compared to the source version
instead of showing a full addition.</li>
<li>Merging: When one side of a merge (or rebase) has renamed a file and the other
side has modified it, propagate the changes to the other side. (There are many
other cases to handle too.)</li>
<li>Log: It should be possible to run something like <code dir="auto">jj log -p &#x3C;file></code> and follow
the file backwards when it had been created by copying.</li>
<li>Annotate (blame): Similar to the log use case, we should follow the file
backwards when it had been created by copying.</li>
</ul>
<p>The solution should support recording and retrieving copy info in a way that
is performant both for Git, which synthesizes copy info on the fly between
arbitrary trees, and for custom backends which may explicitly record and
re-serve copy info over arbitrarily large commit ranges.</p>
<p>The APIs should be defined in a way that makes it easy for custom backends to
ignore copy info entirely until they are ready to implement it.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="desired-ux">Desired UX</h3><a class="sl-anchor-link" href="#desired-ux"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œDesired UXâ€</span></a></div>
<p>The following sections describe some scenarios and how we would ideally handle
them.</p>
<p>We have not seen much reason to distinguish copies from renames, so a rename
is simply the same thing as a copy plus a deletion. This means that we cannot
distinguish â€œcopy <code dir="auto">foo</code> to <code dir="auto">bar</code> and rename <code dir="auto">foo</code> to <code dir="auto">baz</code>â€ from â€œcopy <code dir="auto">foo</code>
to <code dir="auto">baz</code> and rename <code dir="auto">foo</code> to <code dir="auto">bar</code>â€.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="restoring-from-a-commit-should-preserve-copies">Restoring from a commit should preserve copies</h4><a class="sl-anchor-link" href="#restoring-from-a-commit-should-preserve-copies"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œRestoring from a commit should preserve copiesâ€</span></a></div>
<p>For example, <code dir="auto">jj new X--; jj restore --from X</code> should restore any copies
made in <code dir="auto">X-</code> and <code dir="auto">X</code> into the new working copy. Transitive copies should
be â€œflattenedâ€. For example, if <code dir="auto">X-</code> renamed <code dir="auto">foo</code> to <code dir="auto">bar</code> and <code dir="auto">X</code> renamed
<code dir="auto">bar</code> to <code dir="auto">baz</code>, then the restored commit should rename <code dir="auto">foo</code> to <code dir="auto">baz</code>.</p>
<p>This also applies to reparenting in general, such as for
<a href="https://github.com/martinvonz/jj/issues/1027">â€œverbatim rebaseâ€</a>.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="diff-after-restore">Diff after restore</h4><a class="sl-anchor-link" href="#diff-after-restore"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œDiff after restoreâ€</span></a></div>
<p><code dir="auto">jj restore --from X; jj diff --from X</code> should be empty, at least when it comes
to file contents. It may indicate that renamed file have different history.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="lossless-round-trip-of-rebase">Lossless round-trip of rebase</h4><a class="sl-anchor-link" href="#lossless-round-trip-of-rebase"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œLossless round-trip of rebaseâ€</span></a></div>
<p>Except for the <a href="https://github.com/martinvonz/jj/blob/560d66ecee5a9904b42dbc0b89333f0c27c683de/lib/src/merge.rs#L98-L111"><code dir="auto">A+(A-B)=A</code> rule</a>, rebasing is currently never
lossy; rebasing a commit and then rebasing it back yields the same content. We
should ideally preserve this property when possible.</p>
<p>For example:</p>
<div class="expressive-code"><link rel="stylesheet" href="/starlight/_astro/ec.v4551.css"><script type="module" src="/starlight/_astro/ec.p1z7b.js"></script><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename bar->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r C -o A</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r C -o B </span><span style="--0:#919F9F;--1:#5F636F"># Takes us back to the state above</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logC rename bar->baz|B rename foo->bar|A add foo$ jj rebase -r C -o A$ jj rebase -r C -o B # Takes us back to the state above"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h4"><h4 id="reverting-the-parent-commit-should-be-a-no-op">Reverting the parent commit should be a no-op</h4><a class="sl-anchor-link" href="#reverting-the-parent-commit-should-be-a-no-op"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œReverting the parent commit should be a no-opâ€</span></a></div>
<p>Patches should be reversible so you can make a change and then revert it, and
end up with an empty diff across both commits.</p>
<p>For example:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj revert -r B -o B</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj diff --from B- --to B+ </span><span style="--0:#919F9F;--1:#5F636F"># Should be empty</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logB rename foo->bar|A add foo$ jj revert -r B -o B$ jj diff --from B- --to B+ # Should be empty"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h4"><h4 id="parallelizeserialize">Parallelize/serialize</h4><a class="sl-anchor-link" href="#parallelizeserialize"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œParallelize/serializeâ€</span></a></div>
<p>This is a special case of the lossless rebase.</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">E edit qux</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">D rename baz->qux</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename bar->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj parallelize B::D</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53"># There should be no conflict in E and it should look like a</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53"># regular edit just like before</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r C -A B</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r D -A C</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53"># Now we</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">re back to the same graph as before.</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logE edit qux|D rename baz->qux|C rename bar->baz|B rename foo->bar|A add foo$ jj parallelize B::D$ jj rebase -r C -A B$ jj rebase -r D -A C"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h4"><h4 id="copies-inside-merge-commit">Copies inside merge commit</h4><a class="sl-anchor-link" href="#copies-inside-merge-commit"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œCopies inside merge commitâ€</span></a></div>
<p>We should be able to resolve a naming conflict:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">D  resolve naming conflict by choosing `foo` as the source</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|\</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C | rename bar->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| |</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo and bar</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj file annotate baz </span><span style="--0:#919F9F;--1:#5F636F"># Should not include changes from C</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logD  resolve naming conflict by choosing &#x60;foo&#x60; as the source|\C | rename bar->baz| || B rename foo->baz|/A add foo and bar$ jj file annotate baz # Should not include changes from C"><div></div></button></div></figure></div>
<p>We should also be able to back out that resolution and get back into the
name-conflicted state.</p>
<p>We should be able to rename files that exist on only one side:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">D  rename foo2->foo3 and bar2->bar3</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|\</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C | rename bar->bar2</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| |</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->foo2</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo and bar</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logD  rename foo2->foo3 and bar2->bar3|\C | rename bar->bar2| || B rename foo->foo2|/A add foo and bar"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h4"><h4 id="copies-across-merge-commit">Copies across merge commit</h4><a class="sl-anchor-link" href="#copies-across-merge-commit"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œCopies across merge commitâ€</span></a></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">D delete baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|\</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C | rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| |</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logD delete baz|\C | rename foo->baz| || B rename foo->bar|/A add foo"><div></div></button></div></figure></div>
<p><code dir="auto">jj diff --from C --to D</code> should now show a baz->bar rename (just like
<code dir="auto">jj diff --from C --to B</code> would). <code dir="auto">jj diff --from B --to D</code> should show
no renames. Thatâ€™s despite there being a rename in C.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="high-level-design">High-level Design</h2><a class="sl-anchor-link" href="#high-level-design"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œHigh-level Designâ€</span></a></div>
<p>Jujutsu uses a snapshot-based model similar to Gitâ€™s. The algebra for our
first-class conflicts is also based on snapshots and being able to calculate
patches as differences between states. That means that we have to fit copy
information into that snapshot-based model too <sup><a href="#user-content-fn-martinvonz_slow" id="user-content-fnref-martinvonz_slow" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup>.</p>
<p>The proposal is to update tree objects to also contain information about a
fileâ€™s past names. For example, if file <code dir="auto">foo</code> gets renamed to <code dir="auto">bar</code> in one
commit and then to <code dir="auto">baz</code> in another commit, we will record that <code dir="auto">baz</code> previously
had names <code dir="auto">bar</code> and <code dir="auto">foo</code>.</p>
<p>To support merging two files into one, the list of past names is actually a DAG.
Merging can happen in a merge commit when two sides copy/rename different
source files to the same target file. By having support for it in the model, we
can also support merging multiple files into one in a regular non-merge commit.</p>
<p>To avoid having to store all past paths in the tree object entry, we will write
the copy history as an object and the tree will refer to the object by ID. Each
ID refers to a node in the copy history DAG, similar to how commit IDs refer to
a node in the commit DAG.</p>
<p>Each node in the copy history DAG stores the path. Having the path in the copy
graph can be useful for finding copy sources without having to scan the whole
tree or having to ask the backend.</p>
<p>If we use only the file name as only input to the ID, then we get deterministic
tree IDs. On the other hand, if we add a salt to the copy graph node, then we
can represent that a file was rewritten from scratch. For example, a <code dir="auto">foo</code> might
have copy ID <code dir="auto">123</code> in the previous commit and when the file gets rewritten in
the current commit, it gets copy ID <code dir="auto">456</code> even though there was no copy from an
existing file involved. That makes logical sense, but Iâ€™m not sure how useful
it will be.</p>
<p>The data structure might look like this:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="rust"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// Current `TreeValue::File` variant:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">File { </span><span style="--0:#C5E478;--1:#3B61B0">id</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> FileId, </span><span style="--0:#C5E478;--1:#3B61B0">executable</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> bool },</span></div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// New `TreeValue::File` variant:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">File { </span><span style="--0:#C5E478;--1:#3B61B0">id</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> FileId, </span><span style="--0:#C5E478;--1:#3B61B0">executable</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> bool, </span><span style="--0:#C5E478;--1:#3B61B0">copy_id</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> CopyId },</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5D6376">// A CopyId is a hash of this struct:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">struct</span><span style="--0:#D6DEEB;--1:#403F53"> CopyHistory {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">path</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> RepoPath,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">parents</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;CopyId></span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// Current &#x60;TreeValue::File&#x60; variant:File { id: FileId, executable: bool },// New &#x60;TreeValue::File&#x60; variant:File { id: FileId, executable: bool, copy_id: CopyId },// A CopyId is a hash of this struct:struct CopyHistory {    path: RepoPath,    parents: Vec<CopyId>}"><div></div></button></div></figure></div>
<p>Should we support copy tracking for symlinks? Their history is not very useful
for annotation purposes, but knowing the history may at least be useful for
detecting directory renames (if all files and symlinks in a directory were
renamed).</p>
<p>We probably should not support tracking copied directories because it seems
complicated. I havenâ€™t spent much thinking about it, so itâ€™s also possible that
itâ€™s not that complicated.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="diffing">Diffing</h3><a class="sl-anchor-link" href="#diffing"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œDiffingâ€</span></a></div>
<p>When diffing two trees, we first diff the trees without considering copy info.
For any copy IDs that changed in that diff, we walk all of their copy graphs to
figure out how theyâ€™re related and which source file to associate with which
destination file.</p>
<p>The details of the algorithm is left for the implementation. The following
sections provide some examples to hopefully show that itâ€™s feasible.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-divergent-copy-and-rename">Example: Divergent copy and rename</h4><a class="sl-anchor-link" href="#example-divergent-copy-and-rename"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Divergent copy and renameâ€</span></a></div>
<p>Letâ€™s look at an example of how this model would look in this scenario:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">M rename foo->baz, create bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| L copy foo->bar, create baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="M rename foo->baz, create bar|| L copy foo->bar, create baz|/K add foo"><div></div></button></div></figure></div>
<p>Assuming the new files are different in each commit, we get the following trees.
Notation:</p>
<ul>
<li><code dir="auto">id</code>is the hash of the contents (the <code dir="auto">FileId</code>)</li>
<li>The <code dir="auto">2:bar->1:foo</code> means that copy ID 2 (i.e. hash of the <code dir="auto">CopyHistory</code>
struct) has file <code dir="auto">bar</code>, which was copied from copy ID <code dir="auto">1</code>, where it was
called <code dir="auto">foo</code>.</li>
</ul>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">Commit K:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">name: foo, id: K, copy_id: 1:foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">Commit L:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">name: bar, id: L, copy_id: 2:bar->1:foo</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">name: baz, id: L, copy_id: 3:baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">name: foo, id: K, copy_id: 1:foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">Commit M:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">name: bar, id: M, copy_id: 4:bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">name: baz, id: M, copy_id: 5:baz->1:foo</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="Commit K:name: foo, id: K, copy_id: 1:fooCommit L:name: bar, id: L, copy_id: 2:bar->1:fooname: baz, id: L, copy_id: 3:bazname: foo, id: K, copy_id: 1:fooCommit M:name: bar, id: M, copy_id: 4:barname: baz, id: M, copy_id: 5:baz->1:foo"><div></div></button></div></figure></div>
<p>This graph also shows the relationship between the copy IDs and which commits
they appear in:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="mermaid"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">graph LR</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">subgraph L["Commit L"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">2["2:bar"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">3["3:baz"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">subgraph K["Commit K"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">            </span></span><span style="--0:#D6DEEB;--1:#403F53">1["1:foo"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">end</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">subgraph M["Commit M"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">4["4:bar"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">5["5:baz"]</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">2 --> 1</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">5 --> 1</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="graph LR    subgraph L[&#x22;Commit L&#x22;]        2[&#x22;2:bar&#x22;]        3[&#x22;3:baz&#x22;]        subgraph K[&#x22;Commit K&#x22;]            1[&#x22;1:foo&#x22;]        end    end    subgraph M[&#x22;Commit M&#x22;]        4[&#x22;4:bar&#x22;]        5[&#x22;5:baz&#x22;]    end    2 --> 1    5 --> 1"><div></div></button></div></figure></div>
<p>Letâ€™s first consider the diff from <code dir="auto">K</code> to <code dir="auto">M</code>. Looking at just the trees, that
diff finds that copy IDs 1,4,5 were affected. By walking their graphs, we find
1 and 5 are related, while 4 is not. Considering that copy graph (involving IDs
1 and 5), since <code dir="auto">foo</code> doesnâ€™t exist in the destination and <code dir="auto">baz</code> doesnâ€™t exist
in the source, we consider it a rename.</p>
<p>Letâ€™s now consider the diff from <code dir="auto">L</code> to <code dir="auto">M</code>. This is the same as the diff of the
commit <code dir="auto">M2</code> weâ€™d get by running
<code dir="auto">jj new L; jj bookmark create M2; jj restore --from M --to M2</code> (which would
result in the commit <code dir="auto">M2</code> having the same tree as <code dir="auto">M</code>). Diffing from <code dir="auto">L</code> to
<code dir="auto">M</code> (or <code dir="auto">M2</code>) finds 1,2,3,4,5 as changed copy IDs. By walking their graphs, we
find that 1,2, and 5 are related, while 3 and 4 are not.</p>
<p>The <code dir="auto">bar</code> and <code dir="auto">baz</code> files have unrelated copy graphs, i.e. the copy graphs for
the <code dir="auto">bar</code> file in commit <code dir="auto">L</code> and the <code dir="auto">bar</code> file in commit <code dir="auto">M</code> are disjoint, and
the same is true for the <code dir="auto">baz</code> file. Therefore, we break up their diffs into two
separate diffs for each file.</p>
<p>Among the remaining copy IDs, the shortest path in the copy graph is between
<code dir="auto">foo</code> on the source side and <code dir="auto">baz</code> on the destination side, so we start with.
Since <code dir="auto">foo</code> doesnâ€™t exist on the destination side and <code dir="auto">baz</code> doesnâ€™t exist on the
source side (with a related copy ID), we consider it a rename.</p>
<p>The remaining file is <code dir="auto">bar</code> on the source side. Its closest relative on the
destination side is <code dir="auto">baz</code>. Since we already used <code dir="auto">baz</code> as a rename target for
<code dir="auto">foo</code>, we wonâ€™t consider <code dir="auto">bar</code> renamed to it. So we consider <code dir="auto">bar</code> as copied
into <code dir="auto">baz</code>.</p>
<p>So we get these diffs:</p>
<ul>
<li><code dir="auto">baz</code> is deleted (deleting content <code dir="auto">L</code>)</li>
<li><code dir="auto">bar</code> is created (with content <code dir="auto">M</code>)</li>
<li><code dir="auto">foo</code> is renamed to <code dir="auto">baz</code> (showing diff from <code dir="auto">K</code> to <code dir="auto">M</code>)</li>
<li><code dir="auto">bar</code> is merged into <code dir="auto">baz</code> (showing diff from <code dir="auto">L</code> to <code dir="auto">M</code>)</li>
</ul>
<div class="sl-heading-wrapper level-h4"><h4 id="example-divergent-copy-and-rename-best-rename-target">Example: Divergent copy and rename (best rename target)</h4><a class="sl-anchor-link" href="#example-divergent-copy-and-rename-best-rename-target"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Divergent copy and rename (best rename target)â€</span></a></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">N copy baz->qux</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">M rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| L rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="N copy baz->qux|M rename foo->baz|| L rename foo->bar|/K add foo"><div></div></button></div></figure></div>
<p>When diffing <code dir="auto">L</code> to <code dir="auto">N</code>, we find that all files are related. Since <code dir="auto">bar</code> does
not exist in the destination, we should find a rename target to match it with.
We pick <code dir="auto">baz</code> because itâ€™s closer in the graph than <code dir="auto">qux</code> is. So the diff is:</p>
<ul>
<li><code dir="auto">bar</code> is renamed to <code dir="auto">baz</code></li>
<li><code dir="auto">bar</code> is copied to <code dir="auto">qux</code></li>
</ul>
<div class="sl-heading-wrapper level-h4"><h4 id="example-copy-onto-deleted-file">Example: Copy onto deleted file</h4><a class="sl-anchor-link" href="#example-copy-onto-deleted-file"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Copy onto deleted fileâ€</span></a></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">M copy foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">L delete bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo, bar</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="M copy foo->bar|L delete bar|K add foo, bar"><div></div></button></div></figure></div>
<p>When diffing from <code dir="auto">K</code> to <code dir="auto">M</code>, we notice that <code dir="auto">bar</code> has different and unrelated
copy IDs. We present one record saying that <code dir="auto">bar</code> was deleted, and one record
saying that <code dir="auto">bar</code> was copied from <code dir="auto">foo</code>.</p>
<p>When diffing from <code dir="auto">M</code> to <code dir="auto">K</code>, we will instead present one record that says that
<code dir="auto">bar</code> was created, and one record that says that <code dir="auto">bar</code> was merged into <code dir="auto">foo</code>.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="merging">Merging</h3><a class="sl-anchor-link" href="#merging"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œMergingâ€</span></a></div>
<p>When merging, we need to add a phase before the content-level merging where we
handle copies. As before, we start by creating the completely unresolved merged
tree based on the input trees. To find the relevant copy information, we look at
the files changed in each diff and then look up the full copy graph for each.
For each copy graph, we can then walk the copy graph to find possible target
paths, which we then look up in the other side of the merge. If the path exists
in the tree and has the right copy ID, then we know that the files are related.</p>
<p>We assume that the differences between the bases and the first term in the
conflict can be very large, so we donâ€™t look at that diff. Assuming that the
commit backend can look up the full copy graph based on a given copy ID, we
donâ€™t need that diff for correctness.</p>
<p>Once we have found all copies involved in the merge, we analyze them to find
conflicts, such as when two sides of the merge rename a file to the same
target. If there are conflicts, we leave the trees unchanged. The user can then
resolve the name conflicts using <code dir="auto">jj resolve</code> (once weâ€™ve added support for
that). Depending on how slow the naming conflict phase turns out to be, we may
want to write a flag to commits indicating that they have unresolved naming
conflicts, so subsequent calls can avoid that phase.</p>
<p>When merging trees, we start by rewriting each diff to match any different names
in the destination tree. For example, if the tree conflict is <code dir="auto">A+(B-C)+(D-E)</code>,
then we will rewrite the <code dir="auto">(B-C)</code> diff and the <code dir="auto">(D-E)</code> diff to the paths in <code dir="auto">A</code>.
To translate the <code dir="auto">(B-C)</code> diff, we calculate renames from <code dir="auto">C</code> to <code dir="auto">A</code> and then we
apply those renames to both <code dir="auto">C</code> and <code dir="auto">B</code>. This may result in conflicts.</p>
<p>If a file has a conflict in the copy ID, it will appear as if it doesnâ€™t exist
when materialized. It will therefore not show up in the working copy until the
user has resolved the conflict.</p>
<p>For example:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">M set foo="bye"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| L rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo="hello"</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="M set foo=&#x22;bye&#x22;|| L rename foo->bar|/K add foo=&#x22;hello&#x22;"><div></div></button></div></figure></div>
<p>When rebasing <code dir="auto">M</code> onto <code dir="auto">L</code>, we apply the <code dir="auto">foo->bar</code> rename to the trees in <code dir="auto">M</code>
and its parent.</p>
<p>Another example:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">N rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| M create foo="M"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| |</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| L delete foo</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo="K"</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="N rename foo->bar|| M create foo=&#x22;M&#x22;| || L delete foo|/K add foo=&#x22;K&#x22;"><div></div></button></div></figure></div>
<p>When rebasing <code dir="auto">M</code> onto <code dir="auto">N</code>, we find the <code dir="auto">foo->bar</code> rename in <code dir="auto">N</code>, but since it
is unrelated to the <code dir="auto">foo</code> file in <code dir="auto">M</code> (assuming the <code dir="auto">foo</code> file created in <code dir="auto">M</code>
used a different salt), we will not perform any renames. The new <code dir="auto">foo</code> file
is then simply created in the rebased <code dir="auto">M</code> just like it was before the rebase.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="propagating-changes-across-copies">Propagating changes across copies?</h4><a class="sl-anchor-link" href="#propagating-changes-across-copies"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œPropagating changes across copies?â€</span></a></div>
<p>Should we propagate changes to copies? For example, if youâ€™ve modified file
<code dir="auto">foo</code> and then rebase it onto a commit that copied <code dir="auto">foo</code> to <code dir="auto">bar</code>, should we
apply your change to <code dir="auto">bar</code> too? Mercurial does that but Git doesnâ€™t. Itâ€™s
particularly useful when a file has been split in two. For example, letâ€™s say
youâ€™ve made various changes in file <code dir="auto">foo</code> and then rebase those change onto a
commit that split <code dir="auto">foo</code> into <code dir="auto">foo1</code> and <code dir="auto">foo2</code> (or <code dir="auto">foo</code> and <code dir="auto">bar</code>). If we
propagate the changes to both files, each change will apply successfully in one
file (assuming the changes do not overlap with the split boundary). Each change
will have a modify/delete conflicts in the other file. Those can relatively
easily be resolved in favor of the deleted hunk. If we do not propagate changes,
then changes that belong in one of the files will instead only appear as
modify/delete conflicts in the first file and you will have to manually copy
over the changes to the copied file.</p>
<p>Propagating changes to copies means that rebasing a commit and then rebasing it
back is no longer a no-op even when ignoring the â€œsame-change ruleâ€. For
example, if your commit modifies file <code dir="auto">foo</code> and you rebase that commit onto a
commit that copied <code dir="auto">foo</code> to <code dir="auto">bar</code>, and then you rebase it back, the same change
will be applied twice to <code dir="auto">foo</code>. However, thanks to the same-change rule, we
wonâ€™t consider it a conflict, so maybe it actually works well in practice.</p>
<p>A third option is to not leave it up to the user whether to propagate the
change across the copy. We can do this by leaving the relevant paths in the
input trees unchanged in the conflicted commit. Then we will redo the copy
tracking process every time the commit is inspected. We can have <code dir="auto">jj resolve</code>
ask the user if they want to propagate the changes to the copy target with a
simple yes/no question per copy target.</p>
<p>Decision: Asking the user about propagating copies seems like the best option.
It avoids surprises, and it makes the conflict algebra work in more cases.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-propagate-changes-to-copied-file-then-rebase-back">Example: Propagate changes to copied file, then rebase back</h4><a class="sl-anchor-link" href="#example-propagate-changes-to-copied-file-then-rebase-back"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Propagate changes to copied file, then rebase backâ€</span></a></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">M foo="M"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| L copy foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo="K"</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="M foo=&#x22;M&#x22;|| L copy foo->bar|/K add foo=&#x22;K&#x22;"><div></div></button></div></figure></div>
<p>Letâ€™s say we rebase <code dir="auto">M</code> onto <code dir="auto">L</code>. Since we decided to not automatically
propagate changes to copies, we will leave the <code dir="auto">M+(L-K)</code> tree unresolved (i.e.
without making any changes to the three trees). If the user does not resolve
the conflict, and instead rebases <code dir="auto">L</code> back onto <code dir="auto">K</code>, the conflict will be
resolved automatically per the usual conflict simplification.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-multiple-copies">Example: Multiple copies</h4><a class="sl-anchor-link" href="#example-multiple-copies"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Multiple copiesâ€</span></a></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">N foo="N"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| M foo="M, foo2="M2", foo3="M3"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| |</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| L copy foo->foo2, copy foo->foo3</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">K add foo="K"</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="N foo=&#x22;N&#x22;|| M foo=&#x22;M, foo2=&#x22;M2&#x22;, foo3=&#x22;M3&#x22;| || L copy foo->foo2, copy foo->foo3|/K add foo=&#x22;K&#x22;"><div></div></button></div></figure></div>
<p>Letâ€™s say we rebase <code dir="auto">M</code> onto <code dir="auto">N</code>. The changes to <code dir="auto">foo</code>, <code dir="auto">foo2</code>, and<code dir="auto"> foo3</code> will
then all apply to <code dir="auto">foo</code>, which means we get a 4-sided conflict.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-convergent-renames">Example: Convergent renames</h4><a class="sl-anchor-link" href="#example-convergent-renames"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Convergent renamesâ€</span></a></div>
<p>Consider this â€œconvergent copy/renameâ€ scenario:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename bar->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo, add bar</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj new B C</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logC rename bar->baz|| B rename foo->baz|/A add foo, add bar$ jj new B C"><div></div></button></div></figure></div>
<p>It seems clear that <code dir="auto">baz</code>â€™s copy graph should inherit from both <code dir="auto">foo</code> and <code dir="auto">bar</code>,
producing a merge in copy graph. The trees would look like this:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">Commit A:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: foo, id: aaa111, copy_id: 1:foo</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: bar, id: aaa111, copy_id: 2:bar</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">Commit B:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: bar, id: aaa111, copy_id: 2:bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: baz, id: aaa111, copy_id: 3:baz->1:foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">Commit C:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: foo, id: aaa111, copy_id: 1:foo</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: baz, id: aaa111, copy_id: 4:baz->2:bar</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">Merge commit:</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">name: baz, id: aaa111, copy_id: 5:baz->{3:baz->1:foo,4:baz->2:bar}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="Commit A:name: foo, id: aaa111, copy_id: 1:fooname: bar, id: aaa111, copy_id: 2:barCommit B:name: bar, id: aaa111, copy_id: 2:barname: baz, id: aaa111, copy_id: 3:baz->1:fooCommit C:name: foo, id: aaa111, copy_id: 1:fooname: baz, id: aaa111, copy_id: 4:baz->2:barMerge commit:name: baz, id: aaa111, copy_id: 5:baz->{3:baz->1:foo,4:baz->2:bar}"><div></div></button></div></figure></div>
<p>We used the same content for both <code dir="auto">foo</code> and <code dir="auto">bar</code> above to simplify. If they
had been different, we would have had a conflict in the contents but the copy
ID would still have been clear.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-rebasing">Example: Rebasing</h4><a class="sl-anchor-link" href="#example-rebasing"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Rebasingâ€</span></a></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename bar->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r C -o A</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logC rename bar->baz|B rename foo->bar|A add foo$ jj rebase -r C -o A"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r C -o B</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logC rename foo->baz|| B rename foo->bar|/A add foo$ jj rebase -r C -o B"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h4"><h4 id="example-rename-added-file">Example: Rename added file</h4><a class="sl-anchor-link" href="#example-rename-added-file"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Rename added fileâ€</span></a></div>
<p>A well-known and thorny problem in Mercurial occurs in the following scenario:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B modify foo</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj squash --from C --into A</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logC rename foo->bar|| B modify foo|/A add foo$ jj squash --from C --into A"><div></div></button></div></figure></div>
<p>The problem here for Mercurial is that after squashing C into A, the new A has
file <code dir="auto">bar</code> but no record that it used to be called <code dir="auto">foo</code>. The design proposed
above handles this case because we keep the copy ID of <code dir="auto">bar</code> after squashing,
so we can detect that the modifications to <code dir="auto">foo</code> in commit B should be
propagated to <code dir="auto">bar</code>.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-divergent-renames">Example: Divergent renames</h4><a class="sl-anchor-link" href="#example-divergent-renames"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: Divergent renamesâ€</span></a></div>
<p>Consider this â€œdivergent renameâ€ scenario:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->bar</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj new B C</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logC rename foo->baz|| B rename foo->bar|/A add foo$ jj new B C"><div></div></button></div></figure></div>
<p>In this scenario, the regular 3-way merge of the trees without considering copy
info results in a tree without conflicts. However, the user might reasonably
expect to have to choose between the <code dir="auto">bar</code> and <code dir="auto">baz</code> names. Hereâ€™s what Git says
in this scenario:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ git merge main</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">CONFLICT (rename/rename): foo renamed to baz in HEAD and to bar in main.</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">Automatic merge failed; fix conflicts and then commit the result.</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ git st</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">HEAD detached from ab0b8e3</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">You have unmerged paths.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">(fix conflicts and run "git commit")</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">(use "git merge --abort" to abort the merge)</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">Unmerged paths:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">(use "git add/rm &#x3C;file>..." as appropriate to mark resolution)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">added by them:   bar</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">added by us:     baz</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">        </span></span><span style="--0:#D6DEEB;--1:#403F53">both deleted:    foo</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ git merge mainCONFLICT (rename/rename): foo renamed to baz in HEAD and to bar in main.Automatic merge failed; fix conflicts and then commit the result.$ git stHEAD detached from ab0b8e3You have unmerged paths.  (fix conflicts and run &#x22;git commit&#x22;)  (use &#x22;git merge --abort&#x22; to abort the merge)Unmerged paths:  (use &#x22;git add/rm <file>...&#x22; as appropriate to mark resolution)        added by them:   bar        added by us:     baz        both deleted:    foo"><div></div></button></div></figure></div>
<p>Interestingly, Git seems to represent this state by using index states that
would not normally end up in the index as a result of conflicts.</p>
<p>Hereâ€™s what Mercurial says:</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ hg merge main</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">note: possible conflict - foo was renamed multiple times to:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53"> </span></span><span style="--0:#D6DEEB;--1:#403F53">bar</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53"> </span></span><span style="--0:#D6DEEB;--1:#403F53">baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">1 files updated, 0 files merged, 0 files removed, 0 files unresolved</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">(branch merge, don't forget to commit)</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ hg merge mainnote: possible conflict - foo was renamed multiple times to: bar baz1 files updated, 0 files merged, 0 files removed, 0 files unresolved(branch merge, don&#x27;t forget to commit)"><div></div></button></div></figure></div>
<p>Mercurial doesnâ€™t have a place to record this state, so it just prints that
note and leaves it at that.</p>
<p>The model and algorithm described in this document would result in a conflict
in the copy ID at both paths after propagating the renames.</p>
<div class="sl-heading-wrapper level-h4"><h4 id="example-jonathantanmys-test-case">Example: @jonathantanmyâ€™s test case:</h4><a class="sl-anchor-link" href="#example-jonathantanmys-test-case"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œExample: @jonathantanmyâ€™s test case:â€</span></a></div>
<p>TODO: fill this out</p>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="console"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj log</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">E baz="baz" (resolves conflict)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">D &#x3C;conflict></span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|\</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">C | rename bar->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| |</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">| B rename foo->baz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">|/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">A add foo="foo" and bar="bar"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj rebase -r E -o C</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">$ jj new D E -m F</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ jj logE baz=&#x22;baz&#x22; (resolves conflict)|D <conflict>|\C | rename bar->baz| || B rename foo->baz|/A add foo=&#x22;foo&#x22; and bar=&#x22;bar&#x22;$ jj rebase -r E -o C$ jj new D E -m F"><div></div></button></div></figure></div>
<p>If F is empty (auto-merged), it should have the same state as E before.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="log">Log</h3><a class="sl-anchor-link" href="#log"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œLogâ€</span></a></div>
<p>The copy graph contains all past paths and copy IDs of a file, so when doing
<code dir="auto">jj log &#x3C;filename></code>, we might want to translate that to a revset thatâ€™s similar
to <code dir="auto">files()</code> but matches specific (path, copy ID) pairs instead of specific
paths.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="annotate">Annotate</h3><a class="sl-anchor-link" href="#annotate"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œAnnotateâ€</span></a></div>
<p>TBD</p>
<div class="sl-heading-wrapper level-h3"><h3 id="representation-in-git">Representation in Git</h3><a class="sl-anchor-link" href="#representation-in-git"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œRepresentation in Gitâ€</span></a></div>
<p>Do we ever want to record renames in the Git backend? If we do, we would
presumably store it outside the Git object, similar to how we store the change
id for commits.</p>
<p>What do we use for trees where we <em>donâ€™t</em> have any copy graph recorded? If we
simply create a new copy graph based on the current path, then the caller will
never find any copies. Do we need an indexing pass to detect all renames in a
repo when running <code dir="auto">jj git init</code>? That can be very expensive for large repos.
For reference, <code dir="auto">git log --summary --find-copies-harder</code> takes about 165 seconds
in the git.git repo on my computer, and about 13 hours in the Nixpkgs repo.</p>
<p>An alternative is to do copy indexing in the background after cloning a repo.
That would mean that copy information would not show up until some time later.
It would also be more work to implement it this way.</p>
<p>How to deal with two trees having the same content but different file ids?
Actually store the additional data linked from the commit object? That would
not work if we point to trees from somewhere thatâ€™s not a commit. We point to a
tree from the working-copy state.</p>
<p>One could imagine not storing any copy info in Git and instead making the model
described above an implementation detail of the backend. Then it could be used
by the native backend and the Google backend, while we still use on-the-fly
copy detection in the Git backend. However, if we want to be able to tell the
user about details of conflicting copy IDs so they can decide how to resolve
such conflicts, then we would have to somehow represent that abstractly too.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="representation-in-cloud-repo-eg-google">Representation in cloud repo (e.g. Google)</h3><a class="sl-anchor-link" href="#representation-in-cloud-repo-eg-google"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œRepresentation in cloud repo (e.g. Google)â€</span></a></div>
<p>Letâ€™s say you have a commit with some files youâ€™ve modified. You now want to
sync (rebase) that to an updated main branch. If some of the files you modified
no longer exist on the main branch, we want to figure out if they were renamed
so we should propagate your changes to the new file location. As described
earlier, we can do that by finding files that have a different copy ID since the
last time you synced with the main branch. However, if there are 10 million new
commits on the main branch, thereâ€™s perhaps tens of thousands of such files
spread across the entire tree. That can therefore can be very expensive to
calculate. We therefore need to be able to get help from a custom backend
implementation with this query.</p>
<p>Since we are only interested in copy graphs that involve files modified in the
rebased commit, it should be sufficient if the backend provides a method to
fetch the whole copy graph for a given copy ID (or list of copy IDs). We would
then first find all copy IDs involved in the diff of the rebased commit. Then
we query the backend to get the full copy graphs. We then need to walk the copy
graphs to see if a node exists in the destination tree.</p>
<p>A weakness of this solution is that the search gets expensive if there are very
many related files. Thatâ€™s probably not much of a problem in practice. The
server might want to populate the index only for public/immutable commits.
Otherwise, a user could poison the index by creating tons of copies
(intentionally or by mistake), which would make all future queries about those
files expensive.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="implementation-plan">Implementation plan</h2><a class="sl-anchor-link" href="#implementation-plan"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œImplementation planâ€</span></a></div>
<p>A rough implementation plan may look like this:</p>
<ol>
<li>Implement support for copy-tracking in the test backend</li>
<li>Implement diff algorithm and test it</li>
<li>Implement merge algorithm and test it</li>
<li>Implement blame algorithm and test it</li>
<li>Implement file-following log algorithm and test it</li>
<li>Extract some queries to the commit backend trait so cloud-based backends
(like the Google backend) can provide versions implemented using database
indexes</li>
<li>Implement support for copy-tracking in the Git backend. This may involve
backfilling, possibly lazily. Or it may involve new abstractions in the
commit backend trait.</li>
<li>Implement CLI for recording copies and for resolving conflicts in copies</li>
</ol>
<div class="sl-heading-wrapper level-h2"><h2 id="alternatives-considered">Alternatives considered</h2><a class="sl-anchor-link" href="#alternatives-considered"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œAlternatives consideredâ€</span></a></div>
<div class="sl-heading-wrapper level-h3"><h3 id="detect-copies-like-git">Detect copies (like Git)</h3><a class="sl-anchor-link" href="#detect-copies-like-git"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œDetect copies (like Git)â€</span></a></div>
<p>Git doesnâ€™t record copy info. Instead, it infers it when comparing two trees.</p>
<p>Itâ€™s hard to make this model scale to very large repos. For example, letâ€™s say
youâ€™re rebasing your local commit to a new upstream commit thatâ€™s 1 million
commits ahead. We would then want to find if any of the files in your local
commit has been copied upstream. Thatâ€™s very expensive to do by comparing the
old and the new base trees. However, since the query APIs defined above take
commits (not trees) as input, we allow the backend to take the history into
account when calculating the copies. A backend can then create an index based
on the input files (in your local commit) and find if itâ€™s been copied without
comparing the full trees.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="record-logical-file-identifiers-in-trees-bitkeeper-like-model">Record logical file identifiers in trees (BitKeeper-like model)</h3><a class="sl-anchor-link" href="#record-logical-file-identifiers-in-trees-bitkeeper-like-model"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œRecord logical file identifiers in trees (BitKeeper-like model)â€</span></a></div>
<p>BitKeeper records a file ID (which identifies a logical file, unlike our <code dir="auto">FileId</code>
type) for each path (or maybe itâ€™s a path for each file ID). That way you can
compare two arbitrary trees, find the added and deleted files and just compare
the file IDs to figure out which of them are renames.</p>
<p>This model doesnâ€™t seem to be easily extensible to support copies (it only
supports renames).</p>
<p>To perform a rebase across millions of commits, we would not want to diff the
full trees because that would be too expensive (probably millions of modified
files). We could perhaps instead find renames by bisecting to find commits that
deleted any of the files modified in the commit weâ€™re rebasing.</p>
<p>Another problem is how to synthesize the file IDs in the Git backend. That could
perhaps be done by walking from the root commits and persisting an index.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="include-copy-info-in-the-fileid-mercurial-like-model">Include copy info in the FileId (Mercurial-like model)</h3><a class="sl-anchor-link" href="#include-copy-info-in-the-fileid-mercurial-like-model"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œInclude copy info in the FileId (Mercurial-like model)â€</span></a></div>
<p>Mercurial stores copy info in a metadata section in the file content itself
<sup><a href="#user-content-fn-mercurial_changeset_copies" id="user-content-fnref-mercurial_changeset_copies" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup>. That means that a file will get a new file
(content) ID if its copy history changes. Thatâ€™s quite similar to the proposal
in this document. One difference is that Mercurialâ€™s model stores information
only about the most recent copy. If the file is then modified, it will get a new
file ID. One therefore has to walk the history of the file to find the previous
name (which is usually not much of a problem because Mercurial stores a revision
DAG per file in addition to the revision DAG at the commit level).</p>
<div class="sl-heading-wrapper level-h3"><h3 id="hybrid-snapshotpatch-model-with-copy-info-stored-in-commits">Hybrid snapshot/patch model with copy info stored in commits</h3><a class="sl-anchor-link" href="#hybrid-snapshotpatch-model-with-copy-info-stored-in-commits"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œHybrid snapshot/patch model with copy info stored in commitsâ€</span></a></div>
<p>We considered storing copy info about the copies/renames in the commit object.
That has some significant impact on the data model:</p>
<ul>
<li>Without copy info, if thereâ€™s a linear chain of commits A..D, you can find
the total diff by diffing just D-A. That works because (B-A)+(C-B)+(D-C)
simplifies to just D-A. However, if there is copy info, the total diff will
involve copy info. If thatâ€™s associated with the individual commits, we will
need to aggregate it somehow.</li>
<li>Restoring from another tree is no longer just a matter of copying that tree;
we also need to figure out copies between the old tree and the new tree.</li>
<li>Conflict states are represented by a series of states to add and remove. This
does not work with the patch-based copy info. We spent a lot of time trying
to figure out a solution that works, but it seems like the snapshot-based
conflict model and the patch-based copy info model are not reconcilable.
Therefore, we wonâ€™t track conflicted copy info, such as between a <code dir="auto">foo</code>-><code dir="auto">baz</code>
rename and a <code dir="auto">bar</code>-><code dir="auto">baz</code> rename.</li>
<li>Since copy records are relative to the auto-merged parents, that unfortunately
means that the records will depend on the merge algorithm, so itâ€™s possible
that a future change to the merge algorithm will make some copy records
invalid. We will therefore need to not assume that the copy source exists.</li>
</ul>
<p>For the state in conflicted commits, we considered using a representation like
this:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="rust"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">struct</span><span style="--0:#D6DEEB;--1:#403F53"> MergedTree {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">snapshot</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Tree,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">diffs</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Diff</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">struct</span><span style="--0:#D6DEEB;--1:#403F53"> Diff {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">before</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Tree,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">after</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Tree,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#919F9F;--1:#5F636F">/// Copies from `before` to `after`</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">copies</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;CopyInfo>,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#919F9F;--1:#5F636F">/// Copies from `before` to `snapshot`</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">copies_to_snapshot</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;CopyInfo>,</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">struct</span><span style="--0:#D6DEEB;--1:#403F53"> CopyInfo {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">source</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> RepoPathBuf,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">target</span><span style="--0:#7FDBCA;--1:#096E72">:</span><span style="--0:#D6DEEB;--1:#403F53"> RepoPathBuf,</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#919F9F;--1:#5D6376">// Maybe more fields here for e.g. "do not propagate"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="struct MergedTree {    snapshot: Tree,    diffs: Diff}struct Diff {    before: Tree,    after: Tree,    /// Copies from &#x60;before&#x60; to &#x60;after&#x60;    copies: Vec<CopyInfo>,    /// Copies from &#x60;before&#x60; to &#x60;snapshot&#x60;    copies_to_snapshot: Vec<CopyInfo>,}struct CopyInfo {    source: RepoPathBuf,    target: RepoPathBuf,    // Maybe more fields here for e.g. &#x22;do not propagate&#x22;}"><div></div></button></div></figure></div>
<p>That works for calculating the resulting tree, but it does not seem to allow for
doing the conflict algebra we currently do. That means that things like
parallelizing commits and then serializing them again would lose copy
information.</p>
<section data-footnotes="" class="footnotes"><div class="sl-heading-wrapper level-h2"><h2 class="sr-only" id="footnote-label">Footnotes</h2><a class="sl-anchor-link" href="#footnote-label"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled â€œFootnotesâ€</span></a></div>
<ol>
<li id="user-content-fn-martinvonz_slow">
<p>This took me (@martinvonz) months to really understand. <a href="#user-content-fnref-martinvonz_slow" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">â†©</a></p>
</li>
<li id="user-content-fn-mercurial_changeset_copies">
<p>From around
<a href="https://repo.mercurial-scm.org/hg/rev/49ad315b39ee">https://repo.mercurial-scm.org/hg/rev/49ad315b39ee</a>, Mercurial also
supports storing copy info in commits. That made it the kind of
snapshot/patch model we described above as not working well. <a href="#user-content-fnref-mercurial_changeset_copies" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">â†©</a></p>
</li>
</ol>
</section> </div> <footer class="sl-flex astro-3yyafb3n"> <div class="meta sl-flex astro-3yyafb3n">   </div> <div class="pagination-links print:hidden astro-u2l5gyhi" dir="ltr"> <a href="/starlight/design/tracking-branches/" rel="prev" class="astro-u2l5gyhi"> <svg aria-hidden="true" class="astro-u2l5gyhi astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg> <span class="astro-u2l5gyhi"> Previous <br class="astro-u2l5gyhi"> <span class="link-title astro-u2l5gyhi">Tracking branches</span> </span> </a> <a href="/starlight/design/secure-config/" rel="next" class="astro-u2l5gyhi"> <svg aria-hidden="true" class="astro-u2l5gyhi astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17.92 11.62a1.001 1.001 0 0 0-.21-.33l-5-5a1.003 1.003 0 1 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1.002 1.002 0 0 0 .325 1.639 1 1 0 0 0 1.095-.219l5-5a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76Z"/></svg> <span class="astro-u2l5gyhi"> Next <br class="astro-u2l5gyhi"> <span class="link-title astro-u2l5gyhi">Secure config</span> </span> </a> </div>   </footer>  </div> </div>   </main> </div> </div>  </div> </div>  </body></html>